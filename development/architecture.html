<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture - Matrix Authentication Service</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> About this documentation</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../usage/installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../usage/configuration.html"><strong aria-hidden="true">3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../usage/usage.html"><strong aria-hidden="true">4.</strong> Using the service</a></li><li class="chapter-item expanded "><a href="../usage/cli/index.html"><strong aria-hidden="true">5.</strong> Command line tool</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/cli/config.html"><strong aria-hidden="true">5.1.</strong> config</a></li><li class="chapter-item expanded "><a href="../usage/cli/database.html"><strong aria-hidden="true">5.2.</strong> database</a></li><li class="chapter-item expanded "><a href="../usage/cli/manage.html"><strong aria-hidden="true">5.3.</strong> manage</a></li><li class="chapter-item expanded "><a href="../usage/cli/server.html"><strong aria-hidden="true">5.4.</strong> server</a></li><li class="chapter-item expanded "><a href="../usage/cli/templates.html"><strong aria-hidden="true">5.5.</strong> templates</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="../development/architecture.html" class="active"><strong aria-hidden="true">6.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../development/database.html"><strong aria-hidden="true">7.</strong> Database</a></li><li class="chapter-item expanded "><a href="../development/warp.html"><strong aria-hidden="true">8.</strong> Routing with warp</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Templates</div></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Matrix Authentication Service</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/matrix-org/matrix-authentication-service" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/matrix-org/matrix-authentication-service/edit/main/docs/development/architecture.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>The service is meant to be easily embeddable, with only a dependency to a database.
It is also meant to stay lightweight in terms of resource usage and easily scalable horizontally.</p>
<h2 id="workspace-and-crate-split"><a class="header" href="#workspace-and-crate-split">Workspace and crate split</a></h2>
<p>The whole repository is a <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">Cargo Workspace</a> that includes multiple crates under the <code>/crates</code> directory.</p>
<p>This includes:</p>
<ul>
<li><code>mas-cli</code>: Command line utility, main entry point</li>
<li><code>mas-config</code>: Configuration parsing and loading</li>
<li><code>mas-data-model</code>: Models of objects that live in the database, regardless of the storage backend</li>
<li><code>mas-email</code>: High-level email sending abstraction</li>
<li><code>mas-handlers</code>: Main HTTP application logic</li>
<li><code>mas-iana</code>: Auto-generated enums from IANA registries</li>
<li><code>mas-iana-codegen</code>: Code generator for the <code>mas-iana</code> crate</li>
<li><code>mas-jose</code>: JWT/JWS/JWE/JWK abstraction</li>
<li><code>mas-static-files</code>: Frontend static files (CSS/JS). Includes some frontend tooling</li>
<li><code>mas-storage</code>: Interactions with the database</li>
<li><code>mas-tasks</code>: Asynchronous task runner and scheduler</li>
<li><code>mas-warp-utils</code>: Various filters and utilities for the <code>warp</code> web framework</li>
<li><code>oauth2-types</code>: Useful structures and types to deal with OAuth 2.0/OpenID Connect endpoints. This might end up published as a standalone library as it can be useful in other contexts.</li>
</ul>
<h2 id="important-crates"><a class="header" href="#important-crates">Important crates</a></h2>
<p>The project makes use of a few important crates.</p>
<h3 id="async-runtime-tokio"><a class="header" href="#async-runtime-tokio">Async runtime: <code>tokio</code></a></h3>
<p><a href="https://tokio.rs/">Tokio</a> is the async runtime used by the project.
The choice of runtime does not have much impact on most of the code.</p>
<p>It has an impact when:</p>
<ul>
<li>spawning asynchronous work (as in &quot;not awaiting on it immediately&quot;)</li>
<li>running CPU-intensive tasks. They should be ran in a blocking context using <code>tokio::task::spawn_blocking</code>. This includes password hashing and other crypto operations.</li>
<li>when dealing with shared memory, e.g. mutexes, rwlocks, etc.</li>
</ul>
<h3 id="logging-tracing"><a class="header" href="#logging-tracing">Logging: <code>tracing</code></a></h3>
<p>Logging is handled through the <a href="https://docs.rs/tracing/*/tracing/"><code>tracing</code></a> crate.
It provides a way to emit structured log messages at various levels.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use tracing::{info, debug};

info!(&quot;Logging some things&quot;);
debug!(user = &quot;john&quot;, &quot;Structured stuff&quot;);
<span class="boring">}
</span></code></pre></pre>
<p><code>tracing</code> also provides ways to create spans to better understand where a logging message comes from.
In the future, it will help building OpenTelemetry-compatible distributed traces to help with debugging.</p>
<p><code>tracing</code> is becoming the standard to log things in Rust.
By itself it will do nothing unless a subscriber is installed to -for example- log the events to the console.</p>
<p>The CLI installs <a href="https://docs.rs/tracing-subscriber/*/tracing_subscriber/"><code>tracing-subcriber</code></a> on startup to log in the console.
It looks for a <code>RUST_LOG</code> environment variable to determine what event should be logged.</p>
<h3 id="error-management-thiserror--anyhow"><a class="header" href="#error-management-thiserror--anyhow">Error management: <code>thiserror</code> / <code>anyhow</code></a></h3>
<p><a href="https://docs.rs/thiserror/*/thiserror/"><code>thiserror</code></a> helps defining custom error types.
This is especially useful for errors that should be handled in a specific way, while being able to augment underlying errors with additional context.</p>
<p><a href="https://docs.rs/anyhow/*/anyhow/"><code>anyhow</code></a> helps dealing with chains of errors.
It allows for quickly adding additional context around an error while it is being propagated.</p>
<p>Both crates work well together and complement each other.</p>
<h3 id="database-interactions-sqlx"><a class="header" href="#database-interactions-sqlx">Database interactions: <code>sqlx</code></a></h3>
<p>Interactions with the database are done through <a href="https://github.com/launchbadge/sqlx"><code>sqlx</code></a>, an async, pure-Rust SQL library with compile-time check of queries.
It also handles schema migrations.</p>
<h3 id="web-framework-warp"><a class="header" href="#web-framework-warp">Web framework: <code>warp</code></a></h3>
<p><a href="https://docs.rs/warp/*/warp/"><code>warp</code></a> is an easy, macro-free web framework.
Its composability makes a lot of sense when implementing OAuth 2.0 endpoints, because of the need to deal with a lot of different scenarios.</p>
<h3 id="templates-tera"><a class="header" href="#templates-tera">Templates: <code>tera</code></a></h3>
<p><a href="https://tera.netlify.app/">Tera</a> was chosen as template engine for its simplicity as well as its ability to load templates at runtime.
The builtin templates are embedded in the final binary through some macro magic.</p>
<p>The downside of Tera compared to compile-time template engines is the possibility of runtime crashes.
This can however be somewhat mitigated with unit tests.</p>
<h3 id="crates-from-rustcrypto"><a class="header" href="#crates-from-rustcrypto">Crates from <em>RustCrypto</em></a></h3>
<p>The <a href="https://github.com/RustCrypto">RustCrypto team</a> offer high quality, independent crates for dealing with cryptography.
The whole project is highly modular and APIs are coherent between crates.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../usage/cli/templates.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../development/database.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../usage/cli/templates.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../development/database.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
